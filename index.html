<!doctype html>
<html lang="ko">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>학부모 성취 열람</title>
<style>
:root{ --bg:#0b1220; --card:#101827; --ink:#e6f4ff; --mut:#9fb6cc; --pri:#38bdf8; --priD:#0891b2; --warn:#ef4444; --ok:#22c55e; --line:#203044; }
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b1220,#122033);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif}
.wrap{max-width:1080px;margin:0 auto;padding:18px}
h1{margin:0 0 12px}
.tabs{display:flex;gap:8px;margin:8px 0 12px}
.tab{padding:10px 12px;border-radius:999px;background:#142237;border:1px solid #25374d;color:#a3eaff;cursor:pointer;font-weight:800}
.tab.active{background:#1c314b;color:#fff}
.card{background:var(--card);border:1px solid #1f2b3a;border-radius:16px;padding:16px;margin:10px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.row>*{flex:1}
input{width:100%;padding:12px;border:1px solid #2a3b50;border-radius:12px;background:#0f1b2a;color:#e6f4ff}
.btn{padding:12px 14px;border:0;border-radius:12px;background:var(--pri);color:#00131d;font-weight:900;cursor:pointer}
.btn:hover{background:var(--priD);color:#fff}
.btn.sec{background:#334155;color:#e6f4ff}
.btn.warn{background:#ef4444;color:#fff}
.note{font-size:12px;color:var(--mut)}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;background:#11324e;color:#a3eaff;font-weight:800;font-size:12px}
.grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
.thumb{background:#0f172a;border-radius:12px;overflow:hidden;color:#fff;border:1px solid #1f2b3a}
.thumb img{display:block;width:100%;height:160px;object-fit:cover}
.caption{padding:8px;font-size:12px}
table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:auto;margin-top:6px}
th,td{padding:10px 12px;border-bottom:1px solid #1f2b3a;font-size:14px;text-align:center}
th:first-child,td:first-child{text-align:left}
thead th{background:#132032;position:sticky;top:0}
.err{color:#ffb4c2}
.ok{color:#86efac}
.hide{display:none}
</style>
<body>
<div class="wrap">
  <h1>학부모 성취 열람 <span class="badge" id="apiState">API 확인 중…</span></h1>

  <div class="tabs">
    <button class="tab active" id="tabOrg">기관 조회</button>
    <button class="tab" id="tabLocal">가정(이 기기) 조회</button>
  </div>

  <!-- 기관 경로 -->
  <div id="orgPane">
    <div class="card">
      <h3>기관에서 조회</h3>
      <div class="row">
        <input id="school" placeholder="기관명">
        <input id="klass"  placeholder="학급명">
        <input id="pcode"  placeholder="학부모코드(공용코드+두 자리 번호, 예:FIRE1207)">
      </div>
      <div class="row">
        <button class="btn" id="btnCheck">자녀 찾기</button>
        <button class="btn sec" id="btnReload">다시 불러오기</button>
      </div>
      <div class="note">* 교사로부터 받은 <b>학부모 공용코드</b>에 <b>자녀 번호(01~99)</b>를 붙여 입력하세요. 예: <code>FIRE12</code> + <code>07</code> → <code>FIRE1207</code></div>
      <div class="note" id="orgMsg"></div>
    </div>

    <div class="card hide" id="childCard">
      <h3>자녀 정보</h3>
      <div class="note">기관: <b id="vSchool"></b> · 학급: <b id="vKlass"></b> · 자녀번호: <b id="vNo"></b> · 이름: <b id="vChild"></b></div>
    </div>

    <div class="card hide" id="tableCard">
      <h3>문항별 최신 결과</h3>
      <div id="tableWrap"></div>
      <div class="note" id="tableMsg"></div>
    </div>

    <div class="card hide" id="gridCard">
      <h3>썸네일</h3>
      <div id="grid" class="grid"></div>
    </div>
  </div>

  <!-- 가정(로컬) 경로 -->
  <div id="localPane" class="hide">
    <div class="card">
      <h3>가정에서 조회(이 기기만)</h3>
      <div class="row">
        <input id="childLocal" placeholder="유아명">
        <input id="parentLocal" placeholder="학부모명">
        <input id="pwLocal" type="password" placeholder="가정용 비밀번호(이 기기에만 저장)">
      </div>
      <div class="row">
        <button class="btn" id="btnSaveLocal">등록/갱신</button>
        <button class="btn sec" id="btnClearLocal">로컬 자료 초기화</button>
      </div>
      <div class="note" id="localMsg"></div>
    </div>

    <div class="card">
      <h3>로컬 성취 추가(선택)</h3>
      <div class="row">
        <input id="localProb" placeholder="문항코드(예:P1)">
        <input id="localFile" type="file" accept="image/*">
        <button class="btn" id="btnAddLocal">추가</button>
      </div>
      <div class="note">* 서버 전송 없이 이 기기에만 저장됩니다. 기기 변경 시 이력은 이동되지 않습니다.</div>
    </div>

    <div class="card">
      <h3>로컬 성취(최신)</h3>
      <div id="localTableWrap"></div>
      <div id="localGrid" class="grid"></div>
    </div>
  </div>
</div>
<script>
// === 부모용 EXEC 고정 부트스트랩(디자인/로직 불변) ===
(function(){
  var PEXEC_CONST = "https://script.google.com/macros/s/AKfycbxeH8HMfKb6qoodtpVxrfmxObk7sffz-58y0ErZkR_-m0M0VVF1sBaLO-cwGaxQQi0vEQ/exec";
  var q = new URLSearchParams(location.search);
  var fromQuery = (q.get('exec')||'').trim();
  var ex = fromQuery || (localStorage.getItem('PEXEC')||'').trim() || PEXEC_CONST;
  window.PEXEC = ex;
  try{ localStorage.setItem('PEXEC', ex); }catch(_){ }
})();
</script>

<script>
// ========= 설정 =========

// 학부모용 웹앱 URL(같은 프로젝트에서 배포한 R7P Code.gs의 URL로 교체하세요)
const PEXEC = "https://script.google.com/macros/s/AKfycbyAbSq8dFnO4PHnX71ni4LVG0zDZcYSBGl2AvrbMdFmBj9iLX-Q4Gl7I9t_wM1oVEGOiA/exec";

const $=id=>document.getElementById(id);
function jsonp(url, timeout=10000){
  return new Promise((res,rej)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    let done=false; const t=setTimeout(()=>{ if(done)return; done=true; cleanup(); rej(new Error('timeout')); }, timeout);
    function cleanup(){ try{ delete window[cb]; s.remove(); }catch(_){ } clearTimeout(t); }
    window[cb]=(d)=>{ if(done)return; done=true; cleanup(); res(d); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb; s.onerror=()=>{ if(done)return; done=true; cleanup(); rej(new Error('network')); };
    document.body.appendChild(s);
  });
}
function setApiState(ok){ const b=$('apiState'); if(ok){b.textContent='API 연결됨';b.style.background='#0d3a2a';b.style.color='#9ffabf';} else {b.textContent='API 오류';b.style.background='#3a1820';b.style.color='#ffb4c2';} }
(async()=>{ try{ const j=await jsonp(PEXEC+'?action=ping'); setApiState(j&&j.ok); }catch(e){ setApiState(false);} })();

// ========= 탭 전환 =========
$('tabOrg').onclick=()=>{ $('tabOrg').classList.add('active'); $('tabLocal').classList.remove('active'); $('orgPane').classList.remove('hide'); $('localPane').classList.add('hide'); };
$('tabLocal').onclick=()=>{ $('tabLocal').classList.add('active'); $('tabOrg').classList.remove('active'); $('localPane').classList.remove('hide'); $('orgPane').classList.add('hide'); renderLocal(); };

// ========= 기관 경로 =========
let lastTk='', lastChild='';
$('btnCheck').onclick=resolveAndLoad;
$('btnReload').onclick=loadChildItems;

async function resolveAndLoad(){
  const s=$('school').value.trim(), k=$('klass').value.trim(), pc=$('pcode').value.trim();
  if(!s||!k||!pc){ $('orgMsg').textContent='기관/학급/학부모코드를 모두 입력하세요.'; return; }
  $('orgMsg').textContent='자녀 확인 중…';
  try{
    const j=await jsonp(PEXEC+'?'+new URLSearchParams({action:'resolveByParentCode',schoolId:s,classId:k,parentCode:pc}));
    if(j&&j.ok){
      lastTk=j.tk||''; lastChild=j.child||'';
      $('vSchool').textContent=j.schoolId||s; $('vKlass').textContent=j.classId||k;
      $('vNo').textContent = String(j.childNo||'').padStart(2,'0');
      $('vChild').textContent = lastChild || '(이름 미등록)';
      $('childCard').classList.remove('hide');
      $('orgMsg').textContent='확인 완료. 최신 성취를 불러옵니다…';
      // 세션 저장
      localStorage.setItem('p_school', s); localStorage.setItem('p_klass', k); localStorage.setItem('p_pcode', pc);
      await loadChildItems();
    }else{
      $('orgMsg').innerHTML='<span class="err">실패:</span> '+((j&&j.error)||'검증 실패');
      $('childCard').classList.add('hide'); $('tableCard').classList.add('hide'); $('gridCard').classList.add('hide');
    }
  }catch(e){ $('orgMsg').textContent='네트워크/시간초과'; }
}
async function loadChildItems(){
  if(!lastTk){ $('orgMsg').textContent='먼저 자녀 확인을 해주세요.'; return; }
  $('tableWrap').innerHTML=''; $('grid').innerHTML=''; $('tableMsg').textContent='불러오는 중…';
  try{
    const j=await jsonp(PEXEC+'?'+new URLSearchParams({action:'listChildLatest',tk:lastTk,child:lastChild}));
    if(!(j&&j.ok)){ $('tableMsg').textContent='조회 실패'; return; }
    const items=j.items||[];
    renderTable(items); renderGrid(items);
    $('tableCard').classList.remove('hide'); $('gridCard').classList.remove('hide');
    $('tableMsg').textContent = items.length? '': '표시할 항목이 없습니다.';
  }catch(e){ $('tableMsg').textContent='네트워크/시간초과'; }
}
function renderTable(items){
  const probs=[...new Set(items.map(x=>x.problem))].sort();
  const wrap=$('tableWrap'); wrap.innerHTML='';
  if(!probs.length){ wrap.innerHTML='<div class="note">아직 업로드된 문항이 없습니다.</div>'; return; }
  const table=document.createElement('table');
  const thead=document.createElement('thead'); const hr=document.createElement('tr');
  const th1=document.createElement('th'); th1.textContent='문항'; hr.appendChild(th1);
  const th2=document.createElement('th'); th2.textContent='미리보기'; hr.appendChild(th2);
  const th3=document.createElement('th'); th3.textContent='촬영시각'; hr.appendChild(th3);
  thead.appendChild(hr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  for(const p of probs){
    const it=items.find(x=>x.problem===p);
    const tr=document.createElement('tr');
    const tdP=document.createElement('td'); tdP.textContent=p; tr.appendChild(tdP);
    const tdI=document.createElement('td');
    if(it){
      const img=document.createElement('img'); img.style.width='120px'; img.style.height='90px'; img.style.objectFit='cover'; img.alt=p; img.dataset.fid=it.fileId;
      tdI.appendChild(img); lazyThumb(img);
      const tdT=document.createElement('td'); tdT.textContent=new Date(it.ts).toLocaleString(); tr.appendChild(tdT);
    }else{
      tdI.textContent='—'; const tdT=document.createElement('td'); tdT.textContent='—'; tr.appendChild(tdT);
    }
    tr.appendChild(tdI);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody); wrap.appendChild(table);
}
function renderGrid(items){
  const g=$('grid'); g.innerHTML='';
  for(const it of items){
    const card=document.createElement('div'); card.className='thumb';
    const img=document.createElement('img'); img.alt=it.problem; img.dataset.fid=it.fileId; lazyThumb(img);
    const cap=document.createElement('div'); cap.className='caption'; cap.textContent=`${it.problem} · ${new Date(it.ts).toLocaleString()}`;
    card.appendChild(img); card.appendChild(cap); g.appendChild(card);
  }
}
const io=new IntersectionObserver(entries=>{
  entries.forEach(async ent=>{
    if(!ent.isIntersecting) return;
    const img=ent.target; io.unobserve(img);
    try{
      const t=await jsonp(PEXEC+'?action=thumbB64&fileId='+encodeURIComponent(img.dataset.fid));
      if(t&&t.ok&&t.b64){ img.src=`data:${t.mime||'image/jpeg'};base64,${t.b64}`; } else { img.replaceWith(document.createTextNode('미리보기 없음')); }
    }catch(_){ img.replaceWith(document.createTextNode('로드 실패')); }
  });
},{rootMargin:'200px'});
function lazyThumb(img){ io.observe(img); }

// 최근 입력값 복원
(function(){ $('school').value=localStorage.getItem('p_school')||''; $('klass').value=localStorage.getItem('p_klass')||''; $('pcode').value=localStorage.getItem('p_pcode')||''; })();

// ========= 가정(로컬) 경로 =========
function getLocalProfile(){ try{return JSON.parse(localStorage.getItem('p_local_profile')||'{}')}catch(_){return{}} }
function setLocalProfile(o){ localStorage.setItem('p_local_profile', JSON.stringify(o)); }
function getLocalAch(){ try{return JSON.parse(localStorage.getItem('p_local_ach')||'{}')}catch(_){return{}} }
function setLocalAch(o){ localStorage.setItem('p_local_ach', JSON.stringify(o)); }

$('btnSaveLocal').onclick=()=>{
  const child=$('childLocal').value.trim(), parent=$('parentLocal').value.trim(), pw=$('pwLocal').value.trim();
  if(!child||!parent||!pw){ $('localMsg').textContent='유아명/학부모명/비밀번호를 모두 입력하세요.'; return; }
  setLocalProfile({child,parent,pw});
  $('localMsg').innerHTML='<span class="ok">저장되었습니다.</span>';
  renderLocal();
};
$('btnClearLocal').onclick=()=>{
  if(!confirm('이 기기에 저장된 로컬 성취 자료를 모두 삭제합니다. 진행할까요?')) return;
  localStorage.removeItem('p_local_ach');
  $('localMsg').textContent='로컬 성취 자료가 초기화되었습니다.';
  renderLocal();
};
$('btnAddLocal').onclick=async()=>{
  const prob=$('localProb').value.trim(); const file=$('localFile').files[0];
  const prof=getLocalProfile(); if(!prof.pw){ $('localMsg').textContent='먼저 상단에서 유아/학부모/비밀번호를 저장하세요.'; return; }
  if(!prob||!file){ $('localMsg').textContent='문항코드와 사진을 선택하세요.'; return; }
  const dataURL=await fileToDataURL(file);
  const db=getLocalAch(); const now=Date.now();
  if(!db[prob] || db[prob].ts<now) db[prob]={ts:now, dataURL:dataURL};
  setLocalAch(db);
  $('localMsg').innerHTML='<span class="ok">추가되었습니다.</span>';
  $('localFile').value=''; renderLocal();
};
function renderLocal(){
  const prof=getLocalProfile(); $('childLocal').value=prof.child||''; $('parentLocal').value=prof.parent||''; $('pwLocal').value=prof.pw||'';
  const db=getLocalAch(); const probs=Object.keys(db).sort();
  const tw=$('localTableWrap'); tw.innerHTML='';
  if(!probs.length){ tw.innerHTML='<div class="note">아직 로컬 성취가 없습니다.</div>'; $('localGrid').innerHTML=''; return; }
  // 표
  const table=document.createElement('table'); const thead=document.createElement('thead'); const hr=document.createElement('tr');
  ['문항','미리보기','시각'].forEach(t=>{ const th=document.createElement('th'); th.textContent=t; hr.appendChild(th); });
  thead.appendChild(hr); table.appendChild(thead);
  const tbody=document.createElement('tbody');
  for(const p of probs){
    const it=db[p]; const tr=document.createElement('tr');
    const tdP=document.createElement('td'); tdP.textContent=p; tr.appendChild(tdP);
    const tdI=document.createElement('td'); const img=document.createElement('img'); img.style.width='120px'; img.style.height='90px'; img.style.objectFit='cover'; img.src=it.dataURL; tdI.appendChild(img); tr.appendChild(tdI);
    const tdT=document.createElement('td'); tdT.textContent=new Date(it.ts).toLocaleString(); tr.appendChild(tdT);
    tbody.appendChild(tr);
  }
  table.appendChild(tbody); tw.appendChild(table);
  // 그리드
  const g=$('localGrid'); g.innerHTML='';
  for(const p of probs){
    const it=db[p]; const card=document.createElement('div'); card.className='thumb';
    const img=document.createElement('img'); img.src=it.dataURL; const cap=document.createElement('div'); cap.className='caption'; cap.textContent=`${p} · ${new Date(it.ts).toLocaleString()}`;
    card.appendChild(img); card.appendChild(cap); g.appendChild(card);
  }
}
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

// 최초 진입 시 로컬 렌더
renderLocal();
</script>
</body>
</html>
